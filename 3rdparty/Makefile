# Makefile for building Fuse dependencies on Windows using MSYS2/MinGW-w64
# Run this from MSYS2 MinGW 64-bit terminal
#
# This Makefile builds:
# - libspectrum (required)
# - audiofile (optional)
# - libxml2 (optional)

# Get the directory where this Makefile is located
SCRIPT_DIR := $(shell cd "$(shell dirname "$(abspath $(lastword $(MAKEFILE_LIST)))")" && pwd)
DIST_PREFIX := $(SCRIPT_DIR)/dist

# Export PKG_CONFIG_PATH
export PKG_CONFIG_PATH := $(DIST_PREFIX)/lib/pkgconfig:$(PKG_CONFIG_PATH)

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m

.PHONY: all clean distclean libspectrum audiofile libxml2 mbedtls check-tools check-libspectrum extract-audiofile extract-libxml2 libspectrum-with-audiofile

all: check-tools check-libspectrum dist-dirs libspectrum
	@if [ -d "audiofile-patched" ] || [ -f "audiofile-patched.zip" ]; then \
		$(MAKE) libspectrum-with-audiofile; \
	fi
	@if [ -d "libxml2-2.9.12" ] || [ -f "libxml2-2.9.12.tar.gz" ]; then \
		$(MAKE) libxml2; \
	fi
	@if [ -d "mbedtls/src" ]; then \
		$(MAKE) mbedtls; \
	fi
	@echo ""
	@echo "$(GREEN)=== Library build complete! ===$(NC)"
	@echo ""
	@echo "Libraries installed to: $(DIST_PREFIX)"
	@echo "  - DLLs: $(DIST_PREFIX)/bin/"
	@echo "  - Headers: $(DIST_PREFIX)/include/"
	@echo "  - pkg-config: $(DIST_PREFIX)/lib/pkgconfig/"
	@echo ""
	@echo "Built libraries:"
	@echo "  ✓ libspectrum"
	@if [ -d "audiofile-patched" ]; then echo "  ✓ audiofile"; fi
	@if [ -d "libxml2-2.9.12" ]; then echo "  ✓ libxml2"; fi
	@if [ -d "mbedtls/src" ]; then echo "  ✓ mbedtls"; fi
	@echo ""
	@echo "You can now run build-fuse.sh to build Fuse."

# Create dist directory structure
dist-dirs:
	@mkdir -p $(DIST_PREFIX)/bin
	@mkdir -p $(DIST_PREFIX)/lib/pkgconfig
	@mkdir -p $(DIST_PREFIX)/include
	@echo "$(GREEN)Using local dist prefix: $(DIST_PREFIX)$(NC)"

# Check for required tools
check-tools:
	@echo "$(GREEN)Checking for required tools...$(NC)"
	@for tool in gcc make pkg-config; do \
		if ! command -v $$tool >/dev/null 2>&1; then \
			echo "$(RED)Error: $$tool is not installed$(NC)"; \
			echo "Please install it with: pacman -S mingw-w64-x86_64-$$tool"; \
			exit 1; \
		fi; \
		echo "  ✓ $$tool found"; \
	done

# Check if libspectrum submodule exists and is initialized
check-libspectrum:
	@echo ""
	@echo "$(GREEN)Checking for libspectrum...$(NC)"
	@if [ ! -d "libspectrum" ]; then \
		echo "$(YELLOW)libspectrum submodule not found. Initializing...$(NC)"; \
		cd .. && git submodule update --init --recursive && cd 3rdparty; \
	fi

# Extract audiofile if zip exists and directory doesn't
extract-audiofile:
	@if [ -f "audiofile-patched.zip" ] && [ ! -d "audiofile-patched" ]; then \
		echo "$(GREEN)Extracting audiofile...$(NC)"; \
		unzip -q audiofile-patched.zip; \
	fi

# Extract libxml2 if tar.gz exists and directory doesn't
extract-libxml2:
	@if [ -f "libxml2-2.9.12.tar.gz" ] && [ ! -d "libxml2-2.9.12" ]; then \
		echo "$(GREEN)Extracting libxml2...$(NC)"; \
		tar -xzf libxml2-2.9.12.tar.gz; \
	fi

# Build libspectrum (required, without audiofile initially)
libspectrum: dist-dirs check-libspectrum
	@echo ""
	@echo "$(GREEN)Building libspectrum (required)...$(NC)"
	@cd libspectrum && \
	if [ -f Makefile ]; then \
		$(MAKE) distclean || true; \
	fi && \
	if [ ! -f configure ]; then \
		./autogen.sh; \
	fi && \
	./configure --with-fake-glib --without-libaudiofile --without-libgcrypt \
	            --without-zlib --without-bzip2 --prefix="$(DIST_PREFIX)" && \
	$(MAKE) && \
	$(MAKE) install

# Build audiofile (optional)
audiofile: extract-audiofile
	@if [ -d "audiofile-patched" ]; then \
		echo ""; \
		echo "$(GREEN)Building audiofile (optional)...$(NC)"; \
		cd audiofile-patched && \
		if [ -f Makefile ]; then \
			$(MAKE) distclean || true; \
		fi && \
		if [ ! -f configure ]; then \
			./autogen.sh --disable-static --disable-flac --disable-docs --disable-examples; \
		fi && \
		./configure --disable-static --disable-flac --disable-docs --disable-examples --prefix="$(DIST_PREFIX)" && \
		$(MAKE) && \
		$(MAKE) install-strip; \
	fi

# Rebuild libspectrum with audiofile support (if audiofile was built)
libspectrum-with-audiofile: audiofile
	@echo ""
	@echo "$(GREEN)Rebuilding libspectrum with audiofile support...$(NC)"
	@cd libspectrum && \
	$(MAKE) distclean || true && \
	./autogen.sh && \
	./configure --with-fake-glib --with-libaudiofile --without-libgcrypt \
	            --without-zlib --without-bzip2 --prefix="$(DIST_PREFIX)" && \
	$(MAKE) && \
	$(MAKE) install

# Build libxml2 (optional)
libxml2: extract-libxml2
	@if [ -d "libxml2-2.9.12" ]; then \
		echo ""; \
		echo "$(GREEN)Building libxml2 (optional)...$(NC)"; \
		cd libxml2-2.9.12 && \
		if [ -f Makefile ]; then \
			$(MAKE) distclean || true; \
		fi && \
		./configure --disable-static --without-iconv --without-python --without-lzma --prefix="$(DIST_PREFIX)" && \
		$(MAKE) && \
		$(MAKE) install-strip; \
	fi

# Build mbedtls (optional, required for TLS/HTTPS support)
mbedtls:
	@if [ -d "mbedtls/src" ]; then \
		echo ""; \
		echo "$(GREEN)Building mbedtls (optional, for TLS support)...$(NC)"; \
		cd mbedtls/src && \
		if [ -f library/Makefile ]; then \
			$(MAKE) clean || true; \
		fi && \
		$(MAKE) WINDOWS=1 SHARED=1 no_test && \
		mkdir -p "$(DIST_PREFIX)/include/mbedtls" && \
		cp -rp include/mbedtls/* "$(DIST_PREFIX)/include/mbedtls/" && \
		mkdir -p "$(DIST_PREFIX)/lib" && \
		mkdir -p "$(DIST_PREFIX)/bin" && \
		cd library && \
		for lib in libmbedtls libmbedx509 libmbedcrypto; do \
			if [ -f "$$lib.a" ]; then \
				cp -f "$$lib.a" "$(DIST_PREFIX)/lib/" || true; \
			fi && \
			if [ -f "$$lib.dll.a" ]; then \
				cp -f "$$lib.dll.a" "$(DIST_PREFIX)/lib/" || true; \
			fi && \
			if [ -f "$$lib.dll" ]; then \
				cp -f "$$lib.dll" "$(DIST_PREFIX)/bin/" || true; \
			fi; \
		done; \
	fi


# Clean targets
clean:
	@echo "$(YELLOW)Cleaning build artifacts...$(NC)"
	@if [ -d "libspectrum" ] && [ -f "libspectrum/Makefile" ]; then \
		cd libspectrum && $(MAKE) distclean || true; \
	fi
	@if [ -d "audiofile-patched" ] && [ -f "audiofile-patched/Makefile" ]; then \
		cd audiofile-patched && $(MAKE) distclean || true; \
	fi
	@if [ -d "libxml2-2.9.12" ] && [ -f "libxml2-2.9.12/Makefile" ]; then \
		cd libxml2-2.9.12 && $(MAKE) distclean || true; \
	fi
	@if [ -d "mbedtls/src" ] && [ -f "mbedtls/src/library/Makefile" ]; then \
		cd mbedtls/src && $(MAKE) clean || true; \
	fi

distclean: clean
	@echo "$(YELLOW)Removing dist directory...$(NC)"
	@rm -rf $(DIST_PREFIX)
